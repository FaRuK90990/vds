build-ubuntu:
    image: ubuntu:16.04
    stage: build
    script:
    - apt-get -qq update
    - apt-get -qq install -y git cmake clang-6.0 gcovr subversion
    - export CC=/usr/bin/clang-6.0
    - export CXX=/usr/bin/clang++-6.0
    - export CFLAGS="-pthread"
    - export CXXFLAGS="-fcoroutines-ts -std=c++17 -fexceptions -lpthread -v  -fPIC"
    - export LDFLAGS="-lstdc++ -Wl -v"
    - cd externals
    - svn -q co http://llvm.org/svn/llvm-project/llvm/trunk llvm
    - cd llvm/projects
    - svn -q co http://llvm.org/svn/llvm-project/libcxx/trunk libcxx
    - svn -q co http://llvm.org/svn/llvm-project/libcxxabi/trunk libcxxabi
    - cd ..
    - mkdir build
    - cd build
    - cmake ..
    - make --quiet cxx
    - make --quiet install-cxx install-cxxabi
    - export CXXFLAGS="-fcoroutines-ts -std=c++17 -fexceptions -lpthread -v -stdlib=libc++ -fPIC"
    - export LDFLAGS="-stdlib=libc++ -lc++ -lc++abi -lpthread -lm ldl"
    - cd ../..
    - git clone --quiet https://github.com/openssl/openssl.git
    - cd openssl
    - ./Configure linux-x86_64-clang no-tests --prefix=$PWD/../openssl-out --openssldir=$PWD/../openssl-out
    - make --quiet
    - make --quiet install
    - cd ..
    - git clone --quiet https://github.com/madler/zlib.git
    - mkdir zlib_out
    - cd zlib_out
    - cmake ../zlib
    - make --quiet
    - make --quiet install
    - cd ..
    - git clone --quiet https://github.com/google/googletest.git
    - mkdir gtest_out
    - cd gtest_out
    - cmake -Dgtest_force_shared_crt=ON ../googletest/googletest
    - make --quiet
    - cd ../..
    - mkdir build
    - cd build
    - ls -R $PWD/../externals/zlib_out/
    - ls -R $PWD/../externals/gtest_out/
    - cmake -DZLIB_INCLUDE_DIR=$PWD/../externals/zlib_out/include -DZLIB_LIBRARY=$PWD/../externals/zlib_out/libz.a -DOPENSSL_ROOT_DIR=$PWD/../externals/openssl-out/ -DGTEST_LIBRARY=$PWD/../externals/gtest_out/lib/libgtest.a -DGTEST_INCLUDE_DIR=$PWD/../externals/googletest/googletest/include -DGTEST_MAIN_LIBRARY=$PWD/../externals/gtest_out/lib/libgtest_main.a .. 
    - make -j4 VERBOSE=1
    - tests/test_vds_core/test_vds_core
    - gcovr -r ..
    